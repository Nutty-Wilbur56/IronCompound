# server.py                                                                                                                                                                                                                                                                                                       import os, socket, fcntl, struct, select, subprocess                                                                                                                                                                                                                                                              from cryptography.hazmat.primitives import serialization, hashes                                                                                                                                                                                                                                                  from cryptography.hazmat.primitives.asymmetric import rsa, padding                                                                                                                                                                                                                                                from cryptography.hazmat.primitives.ciphers.aead import AESGCM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # TUN interface flags                                                                                                                                                                                                                                                                                             TUNSETIFF = 0x400454ca                                                                                                                                                                                                                                                                                            IFF_TUN   = 0x0001                                                                                                                                                                                                                                                                                                IFF_NO_PI = 0x1000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def create_tun(name='tun0'):                                                                                                                                                                                                                                                                                          tun = os.open('/dev/net/tun', os.O_RDWR)                                                                                                                                                                                                                                                                          ifr = struct.pack('16sH', name.encode(), IFF_TUN | IFF_NO_PI)                                                                                                                                                                                                                                                     fcntl.ioctl(tun, TUNSETIFF, ifr)                                                                                                                                                                                                                                                                                  return tun                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      def set_up_tun(name, ip):                                                                                                                                                                                                                                                                                             subprocess.run(['ip', 'addr', 'add', f'{ip}/24', 'dev', name])                                                                                                                                                                                                                                                    subprocess.run(['ip', 'link', 'set', name, 'up'])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def enable_ip_forwarding():                                                                                                                                                                                                                                                                                           with open('/proc/sys/net/ipv4/ip_forward', 'w') as f:                                                                                                                                                                                                                                                                 f.write('1')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def generate_rsa_keypair():                                                                                                                                                                                                                                                                                           private_key = rsa.generate_private_key(public_exponent=65537, key_size=2048)                                                                                                                                                                                                                                      public_key = private_key.public_key()                                                                                                                                                                                                                                                                             return private_key, public_key                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  def serialize_public_key(public_key):                                                                                                                                                                                                                                                                                 return public_key.public_bytes(                                                                                                                                                                                                                                                                                       encoding=serialization.Encoding.PEM,                                                                                                                                                                                                                                                                              format=serialization.PublicFormat.SubjectPublicKeyInfo                                                                                                                                                                                                                                                        )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               def vpn_server():                                                                                                                                                                                                                                                                                                     tun_name = 'tun0'                                                                                                                                                                                                                                                                                                 tun = create_tun(tun_name)                                                                                                                                                                                                                                                                                        set_up_tun(tun_name, '10.8.0.1')                                                                                                                                                                                                                                                                                  enable_ip_forwarding()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Basic NAT setup (adjust if needed)                                                                                                                                                                                                                                                                              subprocess.run(['iptables', '-t', 'nat', '-A', 'POSTROUTING', '-o', 'eth0', '-j', 'MASQUERADE'])                                                                                                                                                                                                                  subprocess.run(['iptables', '-A', 'FORWARD', '-i', tun_name, '-j', 'ACCEPT'])                                                                                                                                                                                                                                     subprocess.run(['iptables', '-A', 'FORWARD', '-o', tun_name, '-j', 'ACCEPT'])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Generate RSA keypair                                                                                                                                                                                                                                                                                            private_key, public_key = generate_rsa_keypair()                                                                                                                                                                                                                                                                  public_key_bytes = serialize_public_key(public_key)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # Listen for incoming client                                                                                                                                                                                                                                                                                      server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)                                                                                                                                                                                                                                                 server_socket.bind(("0.0.0.0", 1871))                                                                                                                                                                                                                                                                             server_socket.listen(1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             print("[+] Waiting for client...")                                                                                                                                                                                                                                                                                client_socket, addr = server_socket.accept()                                                                                                                                                                                                                                                                      print(f"[+] Client connected from {addr}")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # Receive client's public key                                                                                                                                                                                                                                                                                     client_pubkey_bytes = client_socket.recv(2048)                                                                                                                                                                                                                                                                    client_pubkey = serialization.load_pem_public_key(client_pubkey_bytes)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # Send server public key                                                                                                                                                                                                                                                                                          client_socket.sendall(public_key_bytes)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             client_nonce = client_socket.recv(32)                                                                                                                                                                                                                                                                             client_signature = private_key.sign(                                                                                                                                                                                                                                                                                  client_nonce,                                                                                                                                                                                                                                                                                                     padding.PKCS1v15,                                                                                                                                                                                                                                                                                                 hashes.SHA256()                                                                                                                                                                                                                                                                                               )                                                                                                                                                                                                                                                                                                                 clent_socket.sendall(client_signature)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              server_nonce = os.urandom(32)                                                                                                                                                                                                                                                                                     client_socket.sendall(server_nonce)                                                                                                                                                                                                                                                                               client_response = client_socket.recv(256)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           try:                                                                                                                                                                                                                                                                                                                 client_pubkey.verify(                                                                                                                                                                                                                                                                                                 client_response,                                                                                                                                                                                                                                                                                                  server_nonce,                                                                                                                                                                                                                                                                                                     padding.PKCS1v15(),                                                                                                                                                                                                                                                                                               hashes.SHA256()                                                                                                                                                                                                                                                                                               )                                                                                                                                                                                                                                                                                                                 print("Client successfully authenticated")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       except Exception as e:                                                                                                                                                                                                                                                                                                print("Client authentication failed", e)                                                                                                                                                                                                                                                                          client_socket.close()                                                                                                                                                                                                                                                                                             return                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # Receive encrypted AES session key                                                                                                                                                                                                                                                                               enc_key = client_socket.recv(512)                                                                                                                                                                                                                                                                                 aes_key = private_key.decrypt(                                                                                                                                                                                                                                                                                        enc_key,                                                                                                                                                                                                                                                                                                          padding.OAEP(                                                                                                                                                                                                                                                                                                         mgf=padding.MGF1(algorithm=hashes.SHA256()),                                                                                                                                                                                                                                                                      algorithm=hashes.SHA256(),                                                                                                                                                                                                                                                                                        label=None                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                             )                                                                                                                                                                                                                                                                                                                 aes = AESGCM(aes_key)                                                                                                                                                                                                                                                                                             print("[+] AES key established")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # VPN Data Loop                                                                                                                                                                                                                                                                                                   while True:                                                                                                                                                                                                                                                                                                           r, _, _ = select.select([tun, client_socket], [], [])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if tun in r:                                                                                                                                                                                                                                                                                                          packet = os.read(tun, 2048)                                                                                                                                                                                                                                                                                       nonce = os.urandom(12)                                                                                                                                                                                                                                                                                            encrypted_packet = nonce + aes.encrypt(nonce, packet, None)                                                                                                                                                                                                                                                       client_socket.sendall(encrypted_packet)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if client_socket in r:                                                                                                                                                                                                                                                                                                data = client_socket.recv(2048)                                                                                                                                                                                                                                                                                   if not data:                                                                                                                                                                                                                                                                                                          break                                                                                                                                                                                                                                                                                                         nonce = data[:12]                                                                                                                                                                                                                                                                                                 ciphertext = data[12:]                                                                                                                                                                                                                                                                                            try:                                                                                                                                                                                                                                                                                                                  packet = aes.decrypt(nonce, ciphertext, None)                                                                                                                                                                                                                                                                     os.write(tun, packet)                                                                                                                                                                                                                                                                                         except Exception as e:                                                                                                                                                                                                                                                                                                print("[-] Decryption error:", e)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if __name__ == "__main__":                                                                                                                                                                                                                                                                                            vpn_server()